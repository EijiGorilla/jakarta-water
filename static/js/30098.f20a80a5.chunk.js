"use strict";(self.webpackChunkjakarta_water=self.webpackChunkjakarta_water||[]).push([[30098],{30098(t,e,i){i.r(e),i.d(e,{FeatureTileTree3D:()=>Zt});var s=i(89379),r=i(6326),n=i(91967),o=i(19276),l=(i(81806),i(76460)),a=i(30726),u=i(68930),h=i(68134),c=i(75540),d=i(46053),f=(i(47249),i(87990)),v=i(2413),_=i(76191),p=i(20664),m=i(9392),g=i(4763),y=i(95925),T=i(34111),M=i(98510),S=i(45308),w=i(482);var b=i(13927),x=i(61985);class R{constructor(t,e){this._renderCoordsHelper=t,this.opaqueGround=e,this._cache=new Map,this._cameraForward=(0,m.vt)(),this._cameraEye=(0,m.vt)(),this._cameraFovY=55*Math.PI/180,this._frustumBoundingSphereCenter=(0,m.vt)(),this._frustumBoundingSphereRadius=0,this._frustum=new x.P(t),this._renderSR=t.spatialReference;const i=(0,M.lO)(this._renderSR);this._renderSREllipsoidRadius=(0,T.tO)(i).radius}setup(t){this._aboveGround=t.aboveGround,this._frustum.update(t),(0,p.n)(this._cameraForward,t.viewForward),(0,p.d)(this._cameraEye,t.eye),this._cameraFovY=t.fovY,this._updateFrustumBoundingSphere()}done(){this._cache.clear()}compute(t){if(this._cache.has(t.id))return this._cache.get(t.id);const e=this._isVisibleInFrustum(t);return this._cache.set(t.id,e),e}_isVisibleInFrustum(t){return 2===this._renderCoordsHelper.viewingMode?this._isTileVisibleInFrustumLocal(t):this._isTileVisibleInFrustumGlobal(t)}_updateFrustumBoundingSphere(){const t=this._frustum,e=t.origin,i=V;(0,p.n)(i,t.direction);const s=t.points,r=Y;(0,p.a)(r,s[4],e);const n=.5*(0,p.f)(r,r)/(0,p.f)(i,r),o=this._frustumBoundingSphereCenter;(0,p.c)(o,e,i,n);const l=1+n;this._frustumBoundingSphereRadius=l}_isTileVisibleInFrustumLocal(t){const e=t.spatialReference,i=t.extent,s=this._renderSR;if(!i)return!0;if(B[0]=i[0],B[1]=i[1],B[2]=0,B[3]=i[2],B[4]=i[3],B[5]=0,!(0,S.projectBuffer)(B,e,0,B,s,0))return!1;(0,p.j)(P[0],B[0],B[1],0),(0,p.j)(P[1],B[3],B[1],0),(0,p.j)(P[2],B[3],B[4],0),(0,p.j)(P[3],B[0],B[4],0),(0,p.j)(q,.5*(B[0]+B[3]),.5*(B[1]+B[4]),.5*(B[2]+B[5]));const r=wt,n=.5*(0,p.F)(P[0],P[2]),o=this._frustum,l=this._frustumBoundingSphereRadius,a=this._frustumBoundingSphereCenter,u=$;(0,p.a)(u,a,q);const h=(0,p.f)(r,u),c=z;if((0,p.c)(c,q,r,h),(0,p.F)(c,a)>n+l)return!1;const d=this._cameraForward,f=(0,p.f)(d,wt),v=this._cameraFovY,_=this._cameraEye;if(Math.abs(f)<Math.abs(Math.cos(.5*v))){let t=!0;const e=(0,p.j)(bt,d[0],d[1],0),i=(0,p.f)(_,e);for(let s=0;s<4;++s){const r=P[s];if((0,p.f)(r,e)-i>0){t=!1;break}}if(t)return!1}{const t=P[0],e=P[2];if(t[0]<=_[0]&&_[0]<=e[0]&&t[1]<=_[1]&&_[1]<=e[1])return!0}const m=k,g=this.opaqueGround&&this._aboveGround,y=this.opaqueGround&&!this._aboveGround,T=Math.min(y?yt:1/0,h+l),M=Math.max(g?-yt:-1/0,h-l);for(let S=0;S<4;++S)(0,p.c)(m[S],P[S],r,T),(0,p.c)(m[S+4],P[S],r,M);if(A(o.planes,m,8))return!1;if(O(o.planes,m,8))return!0;for(let p=0;p<4;++p){const t=m[p],e=m[p+4];if(xt(o.planes,t,e))return!0;const i=m[(p+1)%4];if(xt(o.planes,t,i))return!0;const s=m[4+(p+1)%4];if(xt(o.planes,e,s))return!0}if(Et[0][3]=+P[0][0],Et[1][3]=-P[2][0],Et[2][3]=+P[0][1],Et[3][3]=-P[2][1],Et[4][3]=+M,Et[5][3]=-T,O(Et,o.points))return!0;if(O(Et,o.points))return!0;for(let p=0;p<4;++p){const t=_,e=o.points[p+4];if(Rt(Et,t,e))return!0;const i=o.points[4+(p+1)%4];if(Rt(Et,e,i))return!0}return!1}_isTileVisibleInFrustumGlobal(t){if(t.level<G)return!0;const e=t.spatialReference,i=t.extent;if(!i||!e)return!0;const s=this.opaqueGround&&this._aboveGround,r=this.opaqueGround&&!this._aboveGround,n=P,o=.5*(i[0]+i[2]);if((0,p.j)(n[0],i[0],i[1],0),(0,p.j)(n[1],i[2],i[1],0),(0,p.j)(n[2],i[2],i[3],0),(0,p.j)(n[3],i[0],i[3],0),(0,p.j)(n[4],o,i[1],0),(0,p.j)(n[5],o,i[3],0),!function(t,e,i,s,r,n){let o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1;const l=(0,w.jd)(e,r);if(null==l)return!1;if(l===w.pO){if(t===s&&i===n)return!0;const e=i+o;for(let r=i,o=n;r<e;++r,++o)(0,p.d)(s[o],t[r]);return!0}const a=i+o;for(let u=i,h=n;u<a;++u,++h)l(t[u],0,s[h],0);return!0}(n,e,0,n,this._renderSR,0,6))return!1;const l=n[0][2]>0,a=n[3][2]<0,u=l||a,h=this._renderSREllipsoidRadius;if(u){const t=N;C(t,Lt,n[0]);const e=U;if(C(e,Lt,n[1]),l){const i=H,s=n[4],r=Z;C(r,s,Lt),C(i,r,s);const o=n[0];(0,p.i)(o,t,i),L(o,h);const l=n[1];(0,p.i)(l,e,i),L(l,h)}else if(a){const i=H,s=n[5],r=Z;C(r,s,Lt),C(i,s,r);const o=n[3];(0,p.i)(o,i,t),L(o,h);const l=n[2];(0,p.i)(l,i,e),L(l,h)}}const c=q,d=(0,p.a)(tt,n[3],n[0]);(0,p.n)(d,d);const f=(0,p.g)(et,n[0],n[3]);(0,p.h)(f,f,.5);const v=-(0,p.f)(f,d),_=(0,p.g)(it,n[0],n[1]);(0,p.h)(_,_,.5);const g=(0,p.g)(st,n[2],n[3]);(0,p.h)(g,g,.5);const y=(0,p.a)(rt,g,_);(0,p.n)(y,y);const T=-(v+(0,p.f)(d,_))/(0,p.f)(d,y);(0,p.c)(c,_,y,T),L(c,h);const M=this._frustumBoundingSphereRadius,S=this._frustumBoundingSphereCenter,x=this._frustum,R=x.planes,j=W;(0,p.n)(j,c);const F=(0,p.f)(n[0],j)/(0,p.H)(n[0]),O=x.origin,k=x.points;let B=!1;if(s){{B=!0;const t=(0,p.n)(Tt,O);for(let e=0;e<4;++e){const i=k[4+e],s=(0,p.a)((0,m.vt)(),i,O);(0,p.n)(s,s);const r=(0,p.i)((0,m.vt)(),t,s);(0,p.n)(r,r);const n=(0,p.i)((0,m.vt)(),s,r);if((0,p.n)(n,n),(0,p.f)(O,n)>h){B=!1;break}}}if(B&&(0,p.f)(O,j)<h*F-yt)return!1;const t=(0,p.n)(Tt,x.origin);if((0,p.f)(t,j)<0)return!1;{const t=(0,p.n)(Mt,x.direction);if((0,p.f)(t,j)>St)return!1}}const V=Math.sqrt(1-F*F);if(V>.9)return!0;let Y=!1;const z=(0,p.f)(j,S),$=(0,p.H)(S);if($<=M&&!R.some(t=>(0,b.mN)(t,J)>0)){if(!s)return!0;Y=!0}const ut=z/$;if(!Y&&z<=0&&-z>M)return!1;const mt=M/$;if(Math.sqrt(1-ut*ut)*Math.sqrt(1-mt*mt)-mt*ut>V)return!1;if(!B){if(n.some(t=>x.intersectsPoint(t)))return!0;if(x.intersectsPoint(c))return!0}const wt=K;(0,p.a)(wt,S,J);const bt=(0,p.f)(wt,j),xt=D;(0,p.h)(xt,j,bt);const Rt=(0,p.F)(xt,S),Ct=e.isWGS84,Et=t.lij,jt=Ct&&Et[2]===2**Et[0]-1,Ft=Ct&&0===Et[2],At=Ft?vt:jt?dt:ht,Ot=Ft?_t:jt?ft:ct;if(!Y){const t=n,e=pt,i=nt,s=ot,r=J;for(const n of At){const o=t[n];if(E(i,t[(n+1)%4],o),E(s,r,o),C(e,s,i),I(e,k,1))return!1}}let Gt=null;if(!s&&bt<1.01*M){const t=2.5*M;if(Rt>F*t+M)return!1;const e=X,i=t/F;for(let s=0;s<4;++s)(0,p.h)(e[s],n[s],i/h);(0,p.j)(e[4],0,0,0),Gt=e}else{const t=(r?h+yt:bt+M)/F,e=s?h-yt:(bt-M)/F,i=Q;for(let s=0;s<4;++s){const r=n[s];(0,p.h)(i[s],r,e/h),(0,p.h)(i[s+4],r,t/h)}Gt=i}if(A(R,Gt,Gt.length))return!1;const It=x.lines,kt=lt,Bt=at;for(const m of It){(0,p.n)(Bt,m.direction);for(const t of Ot){const e=Gt[t];if((0,p.n)(kt,e),gt(Bt,kt,Gt,k))return!1;const i=(t+1)%4;if(s){const t=Gt[i];if((0,p.a)(kt,t,e),(0,p.n)(kt,kt),gt(Bt,kt,Gt,k))return!1}if(r){const e=Gt[4+t],s=Gt[4+i];if((0,p.a)(kt,s,e),(0,p.n)(kt,kt),gt(Bt,kt,Gt,k))return!1}}}return!0}}function C(t,e,i){return(0,p.i)(t,e,i),(0,p.n)(t,t),t}function E(t,e,i){return(0,p.a)(t,e,i),(0,p.n)(t,t),t}function L(t,e){return(0,p.h)(t,t,e/(0,p.H)(t)),t}const j=[0,1,2,3,5];function F(t,e,i){for(let s=0;s<i;++s)if((0,b.mN)(t,e[s])<=0)return!1;return!0}function A(t,e,i){for(const s of j)if(F(t[s],e,i))return!0;return!1}function O(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.length;for(let s=0;s<i;++s){const i=e[s];let r=!0;for(const e of t)if((0,b.mN)(e,i)>0){r=!1;break}if(r)return!0}return!1}const G=2;function I(t,e,i){for(const s of e)if((0,p.f)(s,t)<i)return!1;return!0}const k=[(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)()],B=[0,0,0,0,0,0],P=[(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)()],q=(0,m.vt)(),H=(0,m.vt)(),N=(0,m.vt)(),U=(0,m.vt)(),Z=(0,m.vt)(),W=(0,m.vt)(),D=(0,m.vt)(),V=(0,m.vt)(),Y=(0,m.vt)(),z=(0,m.vt)(),$=(0,m.vt)(),J=(0,m.CN)(0,0,0),K=(0,m.vt)(),Q=[(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)()],X=[(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)()],tt=(0,m.vt)(),et=(0,m.vt)(),it=(0,m.vt)(),st=(0,m.vt)(),rt=(0,m.vt)(),nt=(0,m.vt)(),ot=(0,m.vt)(),lt=(0,m.vt)(),at=(0,m.vt)(),ut=(0,m.vt)(),ht=[0,1,2,3],ct=[0,1,2,3],dt=[0,1,3],ft=[0,1,3],vt=[1,2,3],_t=[1,2,3],pt=(0,m.vt)();const mt=[0,0];function gt(t,e,i,s){const r=i.length,n=s.length;if(0===r||0===n)return!0;const o=ut;C(o,t,e);const l=n<r,a=l?i:s,u=mt;return function(t,e,i){let s=1/0,r=-1/0;for(const n of i){const t=(0,p.f)(e,n);s=Math.min(s,t),r=Math.max(r,t)}t[0]=s,t[1]=r}(u,o,l?s:i),function(t,e,i,s){let r=1/0,n=-1/0;for(const o of s){const s=(0,p.f)(i,o);if(r=Math.min(r,s),n=Math.max(n,s),r<=e&&n>=t)return!1}return!0}(u[0],u[1],o,a)}const yt=430,Tt=(0,m.vt)(),Mt=(0,m.vt)(),St=Math.cos(.25*Math.PI),wt=(0,m.fA)(0,0,1),bt=(0,m.vt)();function xt(t,e,i){const s={t0:0,t1:1};for(const r of j)if(!Ct(t[r],e,i,s))return!1;return s.t0<s.t1}function Rt(t,e,i){const s={t0:0,t1:1};for(const r of t)if(!Ct(r,e,i,s))return!1;return s.t0<s.t1}function Ct(t,e,i,s){let{t0:r,t1:n}=s;const o=(0,b.mN)(t,e),l=(0,b.mN)(t,i);if(o>=0&&l>=0)return!1;if(o<0&&l>=0){const t=-o/(l-o);if(t<r)return!1;t<n&&(n=t)}else if(o>=0&&l<0){const t=o/(o-l);if(t>n)return!1;t>r&&(r=t)}return s.t0=r,s.t1=n,!0}const Et=[(0,b.fA)(-1,0,0,1),(0,b.fA)(1,0,0,-1),(0,b.fA)(0,-1,0,1),(0,b.fA)(0,1,0,-1),(0,b.fA)(0,0,-1,1),(0,b.fA)(0,0,1,-1)],Lt=(0,m.CN)(0,0,1);var jt=i(33062);class Ft{constructor(t,e,i){this._renderCoordsHelper=t,this._tilingScheme=e,this._camera=new jt.A,this._surfaceElevation=0,this._focusOnMap=[0,0],this._visibility=new R(t,i)}set opaqueGround(t){this._visibility.opaqueGround=t}setup(t,e,i){this._camera.copyFrom(t),this._surfaceElevation=i,this._focusOnMap[0]=e.x,this._focusOnMap[1]=e.y,this._visibility.setup(this._camera)}done(){this._visibility.done()}update(t){const{measures:e,extent:i,level:s}=t;i&&(e.visible=this._visibility.compute(t),e.distance=(0,v.Io)(i,this._focusOnMap),e.mergeable=!0,e.lodLevel=G,e.splitPriority=Math.max(0,G-s),e.visible&&(this._isGlobal?this._updateSplitAndLodGlobal(t):this._updateSplitAndLodLocal(t)))}_updateSplitAndLodGlobal(t){const e=t.level,i=this._renderCoordsHelper,{eye:s,fov:r}=this._camera,n=i.referenceEllipsoid.radius,o=(0,p.H)(s)-n;if(2*Math.atan(n/o)<r&&o>0)return void(t.measures.lodLevel=Math.max(e,G));const l=At,{extent:a}=t;if(!a)return;const{_surfaceElevation:u}=this;(0,p.j)(l[0],a[0],a[1],u),(0,p.j)(l[1],a[2],a[1],u),(0,p.j)(l[2],a[2],a[3],u),(0,p.j)(l[3],a[0],a[3],u);const h=(0,p.j)(Ot,.5*(a[0]+a[2]),.5*(a[1]+a[3]),u),c=this._tilingScheme.spatialReference;for(let _=0;_<4;++_)i.toRenderCoords(l[_],c,l[_]);i.toRenderCoords(h,c,h);const d=(0,p.n)(Bt.direction,h),f=(0,p.f)(s,d),v=(0,p.h)(It,d,f);this._updateSplitAndLod(t,l,h,v)}_updateSplitAndLodLocal(t){const e=At,{extent:i}=t;if(!i)return;const{_surfaceElevation:s}=this;(0,p.j)(e[0],i[0],i[1],s),(0,p.j)(e[1],i[2],i[1],s),(0,p.j)(e[2],i[2],i[3],s),(0,p.j)(e[3],i[0],i[3],s);const r=this._tilingScheme.spatialReference;for(let h=0;h<4;++h)this._renderCoordsHelper.toRenderCoords(e[h],r,e[h]);const n=(0,p.j)(Ot,.5*(e[0][0]+e[2][0]),.5*(e[0][1]+e[2][1]),.25*(e[0][2]+e[1][2]+e[2][2]+e[3][2])),o=(0,p.j)(Gt,n[0],n[1],0),{eye:l,far:a}=this._camera,u=(0,p.j)(It,o[0],o[1],l[2]);(0,p.j)(Bt.origin,o[0],o[1],l[2]-2*a),(0,p.d)(Bt.direction,kt),this._updateSplitAndLod(t,e,n,u)}_updateSplitAndLod(t,e,i,s){const r=Math.max((0,p.F)(e[0],e[2]),(0,p.F)(e[1],e[3]),(0,p.F)(e[0],i)+(0,p.F)(i,e[2]),(0,p.F)(e[1],i)+(0,p.F)(i,e[3])),{eye:n,near:o,fov:l,viewForward:a,width:u,height:h,pixelRatio:c,frustum:d}=this._camera,f=(0,p.f)(n,a),v=(0,p.f)(i,a)-f,_=(0,p.F)(i,n);let m=v,y=v,T=_,M=_;const S=(t,e)=>e<o?1:Math.sqrt(t*t-e*e)/e;let w=S(_,v);for(const g of e){const t=(0,p.f)(g,a)-f;m=Math.min(m,t),y=Math.max(y,t);const e=(0,p.F)(g,n);M=Math.max(M,e),T=Math.min(T,e);const i=S(e,t);w=Math.min(w,i)}if(y<o)return void(t.measures.lodLevel=0);const b=Math.cos(.5*l),x=(0,p.F)(n,s);w>b&&x>qt*r&&(y=Ht*M,m=Ht*T);const R=.5*Math.sqrt(u*u+h*h)/c,C=2*Math.tan(.5*l),E=t=>Math.max(o,t)*Pt/R*C,L=t.level,j=r*2**L*Math.max(1,C),F=E(m),A=Math.ceil(Math.log2(Math.max(1,j/F)));if(t.measures.lodLevel=Math.max(A,t.measures.lodLevel),t.measures.splitPriority+=t.measures.lodLevel-L,L<A){const i=+(0,g.bU)(d,e[0])+ +(0,g.bU)(d,e[1])+ +(0,g.bU)(d,e[2])+ +(0,g.bU)(d,e[3]);t.measures.splitPriority+=i}const O=E(y)/F;O>2.5&&(t.measures.splitPriority+=O)}get _isGlobal(){return 1===this._renderCoordsHelper.viewingMode}}const At=[(0,m.vt)(),(0,m.vt)(),(0,m.vt)(),(0,m.vt)()],Ot=(0,m.vt)(),Gt=(0,m.vt)(),It=(0,m.vt)(),kt=(0,m.CN)(0,0,1),Bt=(0,y.fA)(m.uY,kt),Pt=312,qt=.5,Ht=2;var Nt=i(42136),Ut=i(59752);let Zt=class extends n.A{constructor(t){super(t),this.tiles=new o.A,this.tileSize=512,this._idToTile=new Map,this._dirty=(0,c.v)(!1),this._pendingTiles=(0,c.v)(null),this._newTiles=new u.A,this._tests=!1,this._measurements=new Ft(t.renderCoordsHelper,t.terrain.tilingScheme,this._opaqueGround)}initialize(){var t;this.addHandles([(0,h.wB)(()=>this.tileSize,()=>this._reset(),h.pc),(0,h.wB)(()=>{var t,e,i,s,r;return[null===(t=this.pointsOfInterest.cameraOnSurface)||void 0===t?void 0:t.location,null===(e=this.viewState)||void 0===e?void 0:e.contentCamera,null===(i=this.pointsOfInterest.focus)||void 0===i?void 0:i.location,null!==(s=null===(r=this.terrain)||void 0===r?void 0:r.baseOpacity)&&void 0!==s?s:1]},()=>this._setDirty(),h.pc),(0,h.wB)(()=>this.tilingScheme,t=>{this._reset(),this._measurements=new Ft(this.renderCoordsHelper,t,this._opaqueGround)},h.OH),(0,h.wB)(()=>this._opaqueGround,t=>this._measurements.opaqueGround=t,h.OH)]),this._frameWorker=null===(t=this.scheduler)||void 0===t?void 0:t.registerTask(Ut.W6.FEATURE_TILE_TREE,this)}destroy(){this._frameWorker=(0,a.xt)(this._frameWorker),this._measurements=null,this._newTiles.prune()}get tilingScheme(){var t;return null===(t=this.terrain.tilingScheme)||void 0===t?void 0:t.clone()}set filterExtent(t){if(null!=t&&!t.spatialReference.equals(this.viewState.spatialReference))return void l.A.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const e=this._get("filterExtent");if(e===t||null!=e&&t&&e.equals(t))return;const i=null!=t?t.clone():null;this._set("filterExtent",i),this._setDirty()}get _filterExtentRect(){if(null==this.filterExtent)return null;const t=(0,v.vt)();return(0,Nt.k)(this.filterExtent,t,this.tilingScheme.spatialReference),t}get _rootTileIds(){const{tilingScheme:t}=this;return this._filterExtentRect&&t?t.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(t){t!==this._get("suspended")&&(this._set("suspended",t),this._setDirty())}get updating(){return this._dirty.value||!!this._pendingTiles.value}get _opaqueGround(){var t,e;return 1===(null!==(t=null===(e=this.terrain)||void 0===e?void 0:e.baseOpacity)&&void 0!==t?t:1)}_setDirty(){this.suspended||(this._frameWorker?this._dirty.value=!0:this.runTask(Ut.Bb))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(!1),this._dirty.value=!1}get readyToRun(){return this.updating}_reset(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._newTiles.clear(),this._pendingTiles.value=null,t&&this._setDirty()}_getRootTiles(){const t=this.tilingScheme;return this._rootTileIds.map(e=>new _.mS(e[0],e[1],e[2],t))}runTask(t){t=this._tests?Ut.Bb:t,this._dirty.value=!1,this._pendingTiles.value||(this._startUpdate(t),null!=this._frameWorker&&(this._frameWorker.priority=Ut.W6.FEATURE_TILE_TREE_ACTIVE)),this._splitPendingTiles(t),this._pendingTiles.value||null==this._frameWorker||(this._frameWorker.priority=Ut.W6.FEATURE_TILE_TREE)}_startUpdate(t){var e;if(this.suspended)return;if(!this.tilingScheme)return void this._clear();const{_measurements:i,_filterExtentRect:s,_newTiles:r}=this;i.setup(this.viewState.contentCamera,this.pointsOfInterest.focus.location,null!==(e=this.pointsOfInterest.cameraOnSurface.location.z)&&void 0!==e?e:0),this._pendingTiles.value=this._getRootTiles().filter(t=>{if(i.update(t),t.measures.visible&&(!s||!t.extent||(0,v.HY)(t.extent,s))){if(t.measures.splitPriority>0)return!0;r.push(t)}return!1}).sort(Wt),this._newTiles.clear(),t.madeProgress()}_splitPendingTiles(t){const e=this._pendingTiles.value;if(!e)return;const{tilingScheme:i,_filterExtentRect:s,_newTiles:r,_measurements:n}=this;for(;e.length>0&&this._tileBudgetRatio<=2;){const o=e.pop();if(t.madeProgress(),o.measures.splitPriority>0){i.ensureMaxLod(o.level+1);const t=o.createChildren();for(const i of t)n.update(i),!i.measures.visible||s&&i.extent&&!(0,v.HY)(i.extent,s)||(i.measures.splitPriority>0?e.push(i):r.push(i));e.sort(Wt),this._mergeNewTiles(2),this._mergeNewTiles(2,!0)}else r.push(o);if(t.done)return}r.pushArray(e),this._pendingTiles.value=null,this._updateTiles(),r.clear(),n.done()}get _tileBudgetRatio(){var t,e;return(this._newTiles.length+(null!==(t=null===(e=this._pendingTiles.value)||void 0===e?void 0:e.length)&&void 0!==t?t:0))/60}_mergeNewTiles(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this._tileBudgetRatio<=t)return;const{_newTiles:i,_measurements:s}=this;i.sort((t,e)=>e.measures.distance-t.measures.distance);const r=new Map(i.map(t=>[t.id,t])),n=i.length;for(const u of r.values()){var o,l,a;const{lij:n,measures:h}=u;if(!h.mergeable||n[1]%2!=0||n[2]%2!=0||n[0]<=1||u.lodLevelDelta>=4)continue;const c=h.lodLevel;let d=c,f=!0;const v=r.get((0,_.et)(n[0],n[1]+1,n[2]));let p=Math.abs((null!==(o=null===v||void 0===v?void 0:v.measures.lodLevel)&&void 0!==o?o:0)-c),m=0===p||e&&(null===v||void 0===v?void 0:v.measures.mergeable)&&p<=1;if(!v||!m)continue;d+=v.measures.lodLevel,f&&(f=0===p);const g=r.get((0,_.et)(n[0],n[1],n[2]+1));if(p=Math.abs((null!==(l=null===g||void 0===g?void 0:g.measures.lodLevel)&&void 0!==l?l:0)-c),m=0===p||e&&(null===g||void 0===g?void 0:g.measures.mergeable)&&p<=1,!g||!m)continue;d+=g.measures.lodLevel,f&&(f=0===p);const y=r.get((0,_.et)(n[0],n[1]+1,n[2]+1));if(p=Math.abs((null!==(a=null===y||void 0===y?void 0:y.measures.lodLevel)&&void 0!==a?a:0)-c),m=0===p||e&&(null===y||void 0===y?void 0:y.measures.mergeable)&&p<=1,!y||!m)continue;d+=y.measures.lodLevel,f&&(f=0===p),i.removeUnordered(u),i.removeUnordered(v),i.removeUnordered(g),i.removeUnordered(y),r.delete(u.id),r.delete(v.id),r.delete(g.id),r.delete(y.id);const T=new _.mS(n[0]-1,n[1]/2,n[2]/2,this.tilingScheme);if(s.update(T),T.measures.visible=!0,T.measures.lodLevel=d/4,T.measures.mergeable=f,i.push(T),r.set(T.id,T),this._tileBudgetRatio<=t)return}i.length<n&&this._mergeNewTiles(t,e)}_updateTiles(){this._mergeNewTiles(1),this._mergeNewTiles(1,!0);for(const s of this.tiles.items)s.used=!1;let t=!1;const e=this._newTiles.filter(e=>{const i=this._idToTile.get(e.id);return i?(t||(t=i.measures.lodLevel!==e.measures.lodLevel),i.measures=(0,s.A)({},e.measures),i.used=!0):this._idToTile.set(e.id,e),!i}),i=this.tiles.items.filter(t=>!t.used&&(this._idToTile.delete(t.id),!0));this.tiles.removeMany(i),this.tiles.addMany(e),this._sortTiles(),!t||i.length||e.length||this.tiles.emit("change")}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((t,e)=>t.measures.distance-e.measures.distance),this.tiles.forEach((t,e)=>t.loadPriority=e)}};function Wt(t,e){return t.lodLevelDelta-e.lodLevelDelta||t.measures.splitPriority-e.measures.splitPriority||e.measures.distance-t.measures.distance}(0,r.Cg)([(0,d.MZ)({constructOnly:!0})],Zt.prototype,"scheduler",void 0),(0,r.Cg)([(0,d.MZ)({constructOnly:!0})],Zt.prototype,"renderCoordsHelper",void 0),(0,r.Cg)([(0,d.MZ)({constructOnly:!0})],Zt.prototype,"pointsOfInterest",void 0),(0,r.Cg)([(0,d.MZ)({constructOnly:!0})],Zt.prototype,"viewState",void 0),(0,r.Cg)([(0,d.MZ)({constructOnly:!0})],Zt.prototype,"terrain",void 0),(0,r.Cg)([(0,d.MZ)()],Zt.prototype,"tiles",void 0),(0,r.Cg)([(0,d.MZ)()],Zt.prototype,"tileSize",void 0),(0,r.Cg)([(0,d.MZ)({readOnly:!0})],Zt.prototype,"tilingScheme",null),(0,r.Cg)([(0,d.MZ)()],Zt.prototype,"filterExtent",null),(0,r.Cg)([(0,d.MZ)({readOnly:!0})],Zt.prototype,"_filterExtentRect",null),(0,r.Cg)([(0,d.MZ)({readOnly:!0})],Zt.prototype,"_rootTileIds",null),(0,r.Cg)([(0,d.MZ)({value:!1})],Zt.prototype,"suspended",null),(0,r.Cg)([(0,d.MZ)({readOnly:!0})],Zt.prototype,"updating",null),Zt=(0,r.Cg)([(0,f.$)("esri.views.3d.layers.support.FeatureTileTree3D")],Zt)},76191(t,e,i){i.d(e,{Tb:()=>n,et:()=>u,mS:()=>l,nx:()=>o});var s=i(34111),r=i(2413);const n="virtual-snapshot-tile",o="virtual-display-filter-highlight-tile";class l{constructor(t,e,i,s){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:u(t,e,i);this._tilingScheme=s,this.id=n,this.lij=[0,0,0],this.extent=null,this.measures=new a,this.loadPriority=0,this.used=!1,this.lij[0]=this.measures.lodLevel=t,this.lij[1]=e,this.lij[2]=i,s&&(this.extent=(0,r.vt)(),null===s||void 0===s||s.getExtent(t,e,i,this.extent))}get planetRadius(){return(0,s.tO)(this.spatialReference).radius}get spatialReference(){var t;return null===(t=this._tilingScheme)||void 0===t?void 0:t.spatialReference}get resolution(){var t,e;return null!==(t=null===(e=this._tilingScheme)||void 0===e?void 0:e.resolutionAtLevel(this.measures.lodLevel))&&void 0!==t?t:0}get level(){return this.lij[0]}get lodLevelDelta(){return this.measures.lodLevel-this.level}createChildren(){const t=this.lij[0]+1,e=2*this.lij[1],i=2*this.lij[2];return[new l(t,e,i,this._tilingScheme),new l(t,e+1,i,this._tilingScheme),new l(t,e,i+1,this._tilingScheme),new l(t,e+1,i+1,this._tilingScheme)]}}class a{constructor(){this.visible=!0,this.distance=0,this.lodLevel=0,this.splitPriority=0,this.mergeable=!0}}function u(t,e,i){return"".concat(t,"/").concat(e,"/").concat(i)}}}]);
//# sourceMappingURL=30098.f20a80a5.chunk.js.map